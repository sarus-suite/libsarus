inputs:
  image-name:
    description: "Container image name"

runs:
  using: "composite"
  steps:
    - name: Initialize git repository
      shell: bash
      run: git config --global --add safe.directory '*'

    # GitHub enragingly still recommends to use a container as 'root'
    # because if not, actions/checkout sometimes doesn't work (EACCES error).
    # The side effect of using a container as 'root' is that it doesn't
    # automatically enter the Spack environment. So we need to activate it
    # manually once again here.
    - name: Run build script
      shell: bash
      run: |
        rm -r /root
        ln -s /home/docker /root
        cd /root
        export PATH=$PWD/spack/bin:$PATH
        . spack/share/spack/setup-env.sh
        spack env activate spack-environment
        ./build.sh -DBUILD_DIR=$PWD/build

    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ inputs.image-name }}
        path: ./build
